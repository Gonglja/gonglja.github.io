<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>va_list系列的使用及问题 | Gong's Blog</title><meta name="keywords" content="c,coredumped,assembly"><meta name="author" content="lj gong"><meta name="copyright" content="lj gong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="va_list简介 引自 https:&#x2F;&#x2F;www.runoob.com&#x2F;cprogramming&#x2F;c-standard-library-stdarg-h.html  stdarg.h 头文件定义了一个变量类型 va_list 和三个宏，这三个宏可用于在参数个数未知（即参数个数可变）时获取函数中的参数。 可变参数的函数通在参数列表的末尾是使用省略号(,…)定义的。 库变量下面是头文件 stda">
<meta property="og:type" content="article">
<meta property="og:title" content="va_list系列的使用及问题">
<meta property="og:url" content="http://gonglja.github.io/posts/608e8634/index.html">
<meta property="og:site_name" content="Gong&#39;s Blog">
<meta property="og:description" content="va_list简介 引自 https:&#x2F;&#x2F;www.runoob.com&#x2F;cprogramming&#x2F;c-standard-library-stdarg-h.html  stdarg.h 头文件定义了一个变量类型 va_list 和三个宏，这三个宏可用于在参数个数未知（即参数个数可变）时获取函数中的参数。 可变参数的函数通在参数列表的末尾是使用省略号(,…)定义的。 库变量下面是头文件 stda">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2022-02-23T06:40:36.000Z">
<meta property="article:modified_time" content="2022-05-05T06:17:51.121Z">
<meta property="article:author" content="lj gong">
<meta property="article:tag" content="c">
<meta property="article:tag" content="coredumped">
<meta property="article:tag" content="assembly">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://gonglja.github.io/posts/608e8634/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'va_list系列的使用及问题',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2022-05-05 14:17:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204111228921.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="https://gonglja.github.io/Notes"><i class="fa-fw fas fa-link"></i><span> 笔记</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Gong's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="https://gonglja.github.io/Notes"><i class="fa-fw fas fa-link"></i><span> 笔记</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">va_list系列的使用及问题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-23T06:40:36.000Z" title="发表于 2022-02-23 14:40:36">2022-02-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-05T06:17:51.121Z" title="更新于 2022-05-05 14:17:51">2022-05-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E9%9A%8F%E7%AC%94/">技术随笔</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="va_list系列的使用及问题"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://" alt="" style="width:100%"> 

<h2 id="va-list"><a href="#va-list" class="headerlink" title="va_list"></a>va_list</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>引自 <a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-standard-library-stdarg-h.html">https://www.runoob.com/cprogramming/c-standard-library-stdarg-h.html</a></p>
</blockquote>
<p><strong>stdarg.h</strong> 头文件定义了一个变量类型 <strong>va_list</strong> 和三个宏，这三个宏可用于在参数个数未知（即参数个数可变）时获取函数中的参数。</p>
<p>可变参数的函数通在参数列表的末尾是使用省略号(,…)定义的。</p>
<h4 id="库变量"><a href="#库变量" class="headerlink" title="库变量"></a>库变量</h4><p>下面是头文件 stdarg.h 中定义的变量类型：</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">变量 &amp; 描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><strong>va_list</strong> 这是一个适用于 <strong>va_start()、va_arg()</strong> 和 <strong>va_end()</strong> 这三个宏存储信息的类型。</td>
</tr>
</tbody></table>
<h4 id="库宏"><a href="#库宏" class="headerlink" title="库宏"></a>库宏</h4><p>下面是头文件 stdarg.h 中定义的宏：</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">宏 &amp; 描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-macro-va_start.html">void va_start(va_list ap, last_arg)</a> 这个宏初始化 <strong>ap</strong> 变量，它与 <strong>va_arg</strong> 和 <strong>va_end</strong> 宏是一起使用的。<strong>last_arg</strong> 是最后一个传递给函数的已知的固定参数，即省略号之前的参数。</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-macro-va_arg.html">type va_arg(va_list ap, type)</a> 这个宏检索函数参数列表中类型为 <strong>type</strong> 的下一个参数。</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-macro-va_end.html">void va_end(va_list ap)</a> 这个宏允许使用了 <strong>va_start</strong> 宏的带有可变参数的函数返回。如果在从函数返回之前没有调用 <strong>va_end</strong>，则结果为未定义。</td>
</tr>
</tbody></table>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol>
<li>首先包含<code>stdarg.h</code>头文件</li>
<li>使用<code>va_list</code>初始化 指针</li>
<li>使用<code>va_start</code> 将 第2步中创建的指针添加、还有第一个参数</li>
<li>通过<code>va_arg</code> 将 第2步中创建的指针添加、以及要取的数据的类型</li>
<li>…</li>
<li>不使用<code>va_list</code>后，释放<code>va_start</code>的指针</li>
</ol>
<p>示例如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> p1, ...)</span></span>{</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">int</span> a = p1;</span><br><span class="line">    va_start(ap, p1);</span><br><span class="line">    <span class="keyword">double</span> b = va_arg(ap,<span class="keyword">double</span>);</span><br><span class="line">    <span class="keyword">char</span> c  = va_arg(ap,<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">char</span> *d = va_arg(ap,<span class="keyword">char</span> *);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a:%d\r\nb:%lf\r\nc:%d\r\nd:%s\r\n"</span>,a,b,c,d);</span><br><span class="line">    va_end(ap);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">double</span> b = <span class="number">2.2</span>;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="number">0x33</span>;</span><br><span class="line">    <span class="keyword">char</span> *d = <span class="string">"abcderf"</span>;</span><br><span class="line">    test(a,b,c,d);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>将上述代码保存为test.c，使用命令 <code>gcc test.c </code>然后 <code>./a.out</code>执行</p>
<p>正常输出</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:1</span><br><span class="line">b:2.200000</span><br><span class="line">c:51</span><br><span class="line">d:abcderf</span><br></pre></td></tr></tbody></table></figure>



<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>第一次写的代码为以下，编译时爆出几个警告，刚开始没注意，后面运行时发现<code>core dumped.</code> 遂回头查产生改现象的原因。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> p1, ...)</span></span>{</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">int</span> a = p1;</span><br><span class="line">    va_start(ap, p1);</span><br><span class="line">    <span class="keyword">float</span> b = va_arg(ap,<span class="keyword">float</span>);</span><br><span class="line">    <span class="keyword">char</span> c  = va_arg(ap,<span class="keyword">char</span>);</span><br><span class="line">    <span class="keyword">char</span> *d = va_arg(ap,<span class="keyword">char</span> *);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a:%d\r\nb:%lf\r\nc:%d\r\nd:%s\r\n"</span>,a,b,c,d);</span><br><span class="line">    va_end(ap);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">float</span> b = <span class="number">2.2</span>;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="number">0x33</span>;</span><br><span class="line">    <span class="keyword">char</span> *d = <span class="string">"abcderf"</span>;</span><br><span class="line">    test(a,b,c,d);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们注意到有两个warning，翻译一下：当通过<code>...</code>时，<code>float</code>被提升为<code>double</code>，另一个也是类似，<code>char</code> 被提升为<code>int</code>，<strong>所以使用<code>va_arg</code>访问时，传入参数类型为<code>char</code>，需要用<code>va_arg(ap,int)</code>；传入参数为<code>float</code>时，需使用<code>va_arg(arg,double)</code></strong> 。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[gonglja@archlinux hurlex-doc]$ gcc -g0 test.c </span><br><span class="line">In file included from test.c:2:</span><br><span class="line">test.c: In function ‘test’:</span><br><span class="line">test.c:8:25: warning: ‘float’ is promoted to ‘double’ when passed through ‘...’</span><br><span class="line">    8 |     float b = va_arg(ap,float);</span><br><span class="line">      |                         ^</span><br><span class="line">test.c:8:25: note: (so you should pass ‘double’ not ‘float’ to ‘va_arg’)</span><br><span class="line">test.c:8:25: note: if this code is reached, the program will abort</span><br><span class="line">test.c:9:25: warning: ‘char’ is promoted to ‘int’ when passed through ‘...’</span><br><span class="line">    9 |     char c  = va_arg(ap,char);</span><br><span class="line">      |                         ^</span><br><span class="line">test.c:9:25: note: if this code is reached, the program will abort</span><br><span class="line">[gonglja@archlinux hurlex-doc]$ ./a.out </span><br><span class="line">Illegal instruction (core dumped)</span><br><span class="line">[gonglja@archlinux hurlex-doc]$ </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>修改后，程序正常运行。</p>
<p>为什么 当通过<code>...</code>时，<code>float</code>被提升为<code>double</code>？<code>char</code> 提升为<code>int</code>呢？<del>==猜测是由于字节对齐引起的==</del>。</p>
<p><del>为了验证我们的猜测，在这个地方，我们看一下汇编代码，</del></p>
<p><del>由于涉及到浮点数，为了简单，我们简化一下代码，去掉浮点数相关。</del></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> p1, ...)</span></span>{</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">int</span> a = p1;</span><br><span class="line">    va_start(ap, p1);</span><br><span class="line">    <span class="keyword">char</span> c  = va_arg(ap,<span class="keyword">char</span>);	<span class="comment">// 此处存在问题，应改为va_arg(ap,int)</span></span><br><span class="line">    <span class="keyword">char</span> *d = va_arg(ap,<span class="keyword">char</span> *);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a:%d\r\nc:%d\r\nd:%s\r\n"</span>,a,c,d);</span><br><span class="line">    va_end(ap);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="number">51</span>;</span><br><span class="line">    <span class="keyword">char</span> *d = <span class="string">"abcderf"</span>;</span><br><span class="line">    test(a,c,d);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>通过 <code>gcc -S test.c</code> 生成 <code>test.s</code>文件，汇编源码如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">	.file	"test.c"</span><br><span class="line">	.text</span><br><span class="line">	.globl	test</span><br><span class="line">	.type	test, @function</span><br><span class="line">test:</span><br><span class="line">.LFB0:</span><br><span class="line">	.cfi_startproc</span><br><span class="line">	pushq	%rbp</span><br><span class="line">	.cfi_def_cfa_offset 16</span><br><span class="line">	.cfi_offset 6, -16</span><br><span class="line">	movq	%rsp, %rbp</span><br><span class="line">	.cfi_def_cfa_register 6</span><br><span class="line">	subq	$120, %rsp</span><br><span class="line">	movl	%edi, -228(%rbp)</span><br><span class="line">	movq	%rsi, -168(%rbp)</span><br><span class="line">	movq	%rdx, -160(%rbp)</span><br><span class="line">	movq	%rcx, -152(%rbp)</span><br><span class="line">	movq	%r8, -144(%rbp)</span><br><span class="line">	movq	%r9, -136(%rbp)</span><br><span class="line">	testb	%al, %al</span><br><span class="line">	je	.L2</span><br><span class="line">	movaps	%xmm0, -128(%rbp)</span><br><span class="line">	movaps	%xmm1, -112(%rbp)</span><br><span class="line">	movaps	%xmm2, -96(%rbp)</span><br><span class="line">	movaps	%xmm3, -80(%rbp)</span><br><span class="line">	movaps	%xmm4, -64(%rbp)</span><br><span class="line">	movaps	%xmm5, -48(%rbp)</span><br><span class="line">	movaps	%xmm6, -32(%rbp)</span><br><span class="line">	movaps	%xmm7, -16(%rbp)</span><br><span class="line">.L2:</span><br><span class="line">	movq	%fs:40, %rax</span><br><span class="line">	movq	%rax, -184(%rbp)</span><br><span class="line">	xorl	%eax, %eax</span><br><span class="line">	movl	-228(%rbp), %eax</span><br><span class="line">	movl	%eax, -212(%rbp)</span><br><span class="line">	movl	$8, -208(%rbp)</span><br><span class="line">	movl	$48, -204(%rbp)</span><br><span class="line">	leaq	16(%rbp), %rax</span><br><span class="line">	movq	%rax, -200(%rbp)</span><br><span class="line">	leaq	-176(%rbp), %rax</span><br><span class="line">	movq	%rax, -192(%rbp)</span><br><span class="line">	ud2</span><br><span class="line">	.cfi_endproc</span><br><span class="line">.LFE0:</span><br><span class="line">	.size	test, .-test</span><br><span class="line">	.section	.rodata</span><br><span class="line">.LC0:</span><br><span class="line">	.string	"abcderf"</span><br><span class="line">	.text</span><br><span class="line">	.globl	main</span><br><span class="line">	.type	main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB1:</span><br><span class="line">	.cfi_startproc</span><br><span class="line">	pushq	%rbp</span><br><span class="line">	.cfi_def_cfa_offset 16</span><br><span class="line">	.cfi_offset 6, -16</span><br><span class="line">	movq	%rsp, %rbp</span><br><span class="line">	.cfi_def_cfa_register 6</span><br><span class="line">	subq	$16, %rsp</span><br><span class="line">	movl	$1, -12(%rbp)</span><br><span class="line">	movb	$51, -13(%rbp)</span><br><span class="line">	leaq	.LC0(%rip), %rax</span><br><span class="line">	movq	%rax, -8(%rbp)</span><br><span class="line">	movsbl	-13(%rbp), %ecx</span><br><span class="line">	movq	-8(%rbp), %rdx</span><br><span class="line">	movl	-12(%rbp), %eax</span><br><span class="line">	movl	%ecx, %esi</span><br><span class="line">	movl	%eax, %edi</span><br><span class="line">	movl	$0, %eax</span><br><span class="line">	call	test</span><br><span class="line">	movl	$0, %eax</span><br><span class="line">	leave</span><br><span class="line">	.cfi_def_cfa 7, 8</span><br><span class="line">	ret</span><br><span class="line">	.cfi_endproc</span><br><span class="line">.LFE1:</span><br><span class="line">	.size	main, .-main</span><br><span class="line">	.ident	"GCC: (GNU) 11.2.0"</span><br><span class="line">	.section	.note.GNU-stack,"",@progbits</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>只关注重点地方代码，test调用之前，test调用之后。</p>
<p>找到 call test ，在call test之前，</p>
<p>rdi中存着第一个参数，值为1</p>
<p>rsi中存着第二个参数，值为2</p>
<p>rdx中存着第三个参数，值为字符串 的地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://121.4.40.116:20001/i/2022/05/20220223165128.png"></p>
<p>接着调用<code>call test</code>，跳转至<code>test</code>中，首先保存<code>rbp</code>寄存器，更新<code>rbp</code>指针为<code>rsp</code>（栈顶指针），接着栈顶下移（分配空间），将<code>edi</code>、<code>rsi</code>、<code>rax</code>、<code>rcx</code>、<code>r8</code>、<code>r9</code>保存到栈区。为什么是<code>edi</code>呢？因为你的第一个参数为<code>int</code>，而非<code>int64_t</code>。</p>
<p>继续往下走，<code>test %al,%al</code> 其行为类似and（<code>TEST %SRC, %DEST</code> 目的寄存器与源寄存器进行<strong>逻辑与</strong>操作，其结果不更新目的寄存器），<code>je</code> 如果等于0，跳转。</p>
<p>继续往下走，<code>FS:0x28</code>在 Linux 上存储一个特殊的哨兵堆栈保护值，并且代码正在执行堆栈保护检查。</p>
<p>==FS:0x28 之下与 ud2 之前代码未分析。（留个坑）==</p>
<p>然后后面 执行ud2，UD2是一种让CPU产生invalid opcode exception的软件指令. 内核发现CPU出现这个异常, 会立即停止运行。此时就Core Dumped.</p>
<p>以上猜测错误。</p>
<p>**==其实是c99标准中的默认参数提升==**，具体标准如下。</p>
<p><a target="_blank" rel="noopener" href="http://www.open-std.org/JTC1/SC22/wg14/www/docs/n1124.pdf">C99标准</a> 6.5.2.2  函数调用 6、7、8节</p>
<blockquote>
<p>6 If the expression that denotes the called function has a type that does not include a prototype, the integer promotions are performed on each argument, and arguments that have type float are promoted to double. These are called the default argument promotions. If the number of arguments does not equal the number of parameters, the behavior is undefined. If the function is defined with a type that includes a prototype, and either the prototype ends with an ellipsis (, …) or the types of the arguments after promotion are not compatible with the types of the parameters, the behavior is undefined. If the function is defined with a type that does not include a prototype, and the types of the arguments after promotion are not compatible with those of the parameters after promotion, the behavior is undefined, except for the following cases:</p>
<p>​    — one promoted type is a signed integer type, the other promoted type is the corresponding unsigned integer type, and the value is representable in both types; </p>
<p>​    — both types are pointers to qualified or unqualified versions of a character type or void. </p>
<p>7 If the expression that denotes the called function has a type that does include a prototype, the arguments are implicitly converted, as if by assignment, to the types of the corresponding parameters, taking the type of each parameter to be the unqualified version of its declared type. The ellipsis notation in a function prototype declarator causes argument type conversion to stop after the last declared parameter. The default argument promotions are performed on trailing arguments. </p>
<p>8 No other conversions are performed implicitly; in particular, the number and types of arguments are not compared with those of the parameters in a function definition that does not include a function prototype declarator</p>
</blockquote>
<blockquote>
<p>6如果表示被调用函数的表达式具有不包含原型的类型，则对每个参数执行整数提升，并将具有float类型的参数提升为double。这些被称为默认参数提升。如果参数的数量不等于参数的数量，则行为是未定义的。如果函数是用包含原型的类型定义的，并且原型以省略号（，…）结尾或者升级后的参数类型与参数类型不兼容，行为未定义。如果函数定义的类型不包括原型，且升级后参数的类型与升级后参数的类型不兼容，则行为未定义，但以下情况除外：</p>
<ul>
<li>一个升级类型是有符号整数类型，另一个升级类型是相应的无符号整数类型，值在两种类型中都可以表示；</li>
<li>这两种类型都是指向字符类型或void的限定或非限定版本的指针。</li>
</ul>
<p>7 如果表示被调用函数的表达式的类型确实包含原型，则参数会像赋值一样隐式转换为相应参数的类型，将每个参数的类型视为其声明类型的非限定版本。函数原型声明器中的省略号表示法会导致参数类型转换在最后一个声明的参数之后停止。默认参数升级是在后续参数上执行的。</p>
<p>8 没有隐式执行其他转换；特别是，参数的数量和类型不会与不包含函数原型声明器的函数定义中的参数进行比较</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1255775/default-argument-promotions-in-c-function-calls">https://stackoverflow.com/questions/1255775/default-argument-promotions-in-c-function-calls</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/astrotycoon/article/details/8284501">https://blog.csdn.net/astrotycoon/article/details/8284501</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">lj gong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gonglja.github.io/posts/608e8634/">http://gonglja.github.io/posts/608e8634/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gonglja.github.io" target="_blank">Gong's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/c/">c</a><a class="post-meta__tags" href="/tags/coredumped/">coredumped</a><a class="post-meta__tags" href="/tags/assembly/">assembly</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/4e0f05fa/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Multiboot规范</div></div></a></div><div class="next-post pull-right"><a href="/posts/b9ab4680/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">在Vmware上使用archlinux安装open-vm-tools</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/3b31c731/" title="c语言中给定一个函数地址如何调用呢？"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://121.4.40.116:20001/i/2022/05/202204111548715.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-11</div><div class="title">c语言中给定一个函数地址如何调用呢？</div></div></a></div><div><a href="/posts/f2b20ab4/" title="一个简单的测试Linux进程栈空间大小的方法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://121.4.40.116:20001/i/2022/05/20220310100235.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-10</div><div class="title">一个简单的测试Linux进程栈空间大小的方法</div></div></a></div><div><a href="/posts/4bb7b00b/" title="关于实模式与保护模式"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-11</div><div class="title">关于实模式与保护模式</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204111228921.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lj gong</div><div class="author-info__description">蓬生麻中，不扶而直，白沙在涅，与之俱黑。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Gonglja"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/gonglja" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:glj0@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">2022重新出发！加油加油</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#va-list"><span class="toc-number">1.</span> <span class="toc-text">va_list</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%93%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">库变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%93%E5%AE%8F"><span class="toc-number">1.1.2.</span> <span class="toc-text">库宏</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.</span> <span class="toc-text">遇到的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4a17b156/" title="Hello World"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/posts/4a17b156/" title="Hello World">Hello World</a><time datetime="2022-05-05T06:17:51.110Z" title="发表于 2022-05-05 14:17:51">2022-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9faa78d2/" title="设备树"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设备树"/></a><div class="content"><a class="title" href="/posts/9faa78d2/" title="设备树">设备树</a><time datetime="2022-04-29T00:57:30.000Z" title="发表于 2022-04-29 08:57:30">2022-04-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d152f189/" title="cpp使用chrono获取当前时间"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://121.4.40.116:20001/i/2022/05/202204252009405.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cpp使用chrono获取当前时间"/></a><div class="content"><a class="title" href="/posts/d152f189/" title="cpp使用chrono获取当前时间">cpp使用chrono获取当前时间</a><time datetime="2022-04-25T11:51:07.000Z" title="发表于 2022-04-25 19:51:07">2022-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/6b3e9b20/" title="在ubuntu下更新自编译内核"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在ubuntu下更新自编译内核"/></a><div class="content"><a class="title" href="/posts/6b3e9b20/" title="在ubuntu下更新自编译内核">在ubuntu下更新自编译内核</a><time datetime="2022-04-24T07:52:00.000Z" title="发表于 2022-04-24 15:52:00">2022-04-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d05aad81/" title="人为什么会愤怒"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="人为什么会愤怒"/></a><div class="content"><a class="title" href="/posts/d05aad81/" title="人为什么会愤怒">人为什么会愤怒</a><time datetime="2022-04-24T03:32:00.000Z" title="发表于 2022-04-24 11:32:00">2022-04-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By lj gong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'cf6d7d2674b768ef1bf7',
      clientSecret: 'a8254412e77947a4ff26d08ce7af7b5853efbb44',
      repo: 'gonglja.github.io',
      owner: 'Gonglja',
      admin: ['Gonglja'],
      id: 'fa4f4545f703f9a44bd67f4d8c58a947',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>